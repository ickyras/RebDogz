<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Open Mic Sign Up – Rebellion Dogz</title>

    <!-- Site styles -->
    <link rel="stylesheet" href="styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet">

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<header class="site-header">
    <nav class="top-nav">
        <img src="images/aa_logo.png" alt="Rebellion Dogz Logo" class="logo" />
        <a href="index.html" class="nav-button">Home</a>
        <a href="signup.html" class="nav-button">Sign Up</a>
        <a href="contact.html" class="nav-button">Contact</a>
    </nav>
</header>

<section class="event-info event-font">
    <h1 class="section-title">Open Mic Sign Up</h1>

    <p id="authStatus"></p>

    <form id="signupForm">
        <div id="slots"></div>

        <button type="submit" class="nav-button" style="margin-top:2rem;">
            Confirm Slot
        </button>
    </form>

    <p id="message"></p>
</section>

<footer></footer>

<script>
/* ===============================
   SUPABASE CONFIG
   =============================== */

const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_PUBLIC_ANON_KEY';

const supabase = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
);

/* ===============================
   CONSTANTS (MATCH YOUR DATA)
   =============================== */

// ✅ This MUST match your time_slots.event_id
const EVENT_ID = 1;

/* ===============================
   LOAD AVAILABLE SLOTS
   =============================== */

async function loadSignup() {
    const status = document.getElementById('authStatus');
    const slotsDiv = document.getElementById('slots');

    // Check auth
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
        status.textContent = 'Please sign in to book a time slot.';
        return;
    }

    status.textContent = `Signed in as ${user.email}`;

    // Fetch available slots (THIS MATCHES YOUR TABLE)
    const { data: slots, error } = await supabase
        .from('time_slots')
        .select('id, starts_at, ends_at')
        .eq('event_id', EVENT_ID)
        .is('booked_by', null)
        .order('starts_at');

    if (error) {
        console.error(error);
        slotsDiv.textContent = 'Error loading time slots.';
        return;
    }

    if (!slots || slots.length === 0) {
        slotsDiv.textContent = 'No available slots.';
        return;
    }

    // Render slots
    slotsDiv.innerHTML = '';

    slots.forEach(slot => {
        const label = document.createElement('label');
        label.style.display = 'block';
        label.style.marginBottom = '0.75rem';

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = 'slot';
        input.value = slot.id;
        input.required = true;

        const start = new Date(slot.starts_at)
            .toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        const end = new Date(slot.ends_at)
            .toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

        label.appendChild(input);
        label.append(` ${start} – ${end}`);

        slotsDiv.appendChild(label);
    });
}

/* ===============================
   BOOK SLOT
   =============================== */

document.getElementById('signupForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const message = document.getElementById('message');
    const selected = document.querySelector('input[name="slot"]:checked');

    if (!selected) {
        message.textContent = 'Please select a time slot.';
        return;
    }

    const { data: { user } } = await supabase.auth.getUser();

    // Ensure profile exists
    await supabase.from('profiles').upsert({
        id: user.id,
        email: user.email
    });

    // Book the slot (RLS enforces safety)
    const { error } = await supabase
        .from('time_slots')
        .update({ booked_by: user.id })
        .eq('id', selected.value)
        .is('booked_by', null);

    if (error) {
        console.error(error);
        message.textContent = 'That slot was just taken. Please refresh.';
        return;
    }

    message.textContent = '✅ Slot booked successfully!';
    document.getElementById('signupForm').reset();

    // Reload available slots
    loadSignup();
});

/* ===============================
   INIT
   =============================== */

document.addEventListener('DOMContentLoaded', loadSignup);
</script>

</body>
</html>