<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Open Mic Sign Up – Rebellion Dogz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet">

  <!-- Main Global Styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem 3rem;
    }

    input, button {
      padding: 0.6rem;
      border-radius: 4px;
      border: none;
    }

    input {
      width: 100%;
      margin-top: 0.4rem;
    }

    button {
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      margin-top: 0.6rem;
    }

    /* SLOT LAYOUT */
    .slot-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 0.6rem;
    }

    .slot-time {
      flex: 0 0 170px;
    }

    .slot-col {
      flex: 1;
    }

    .booked {
      background: #999;
      cursor: not-allowed;
      color: #000;
    }

    .mine {
      background: rgb(240, 27, 151);
      color: #fff;
    }

    .disabled {
      background: #666;
      color: #ccc;
      cursor: not-allowed;
    }

    .note {
      font-size: 0.9rem;
      opacity: 0.85;
    }
  </style>
</head>

<body>

<header class="site-header">
  <nav class="top-nav">
      <img src="images/aa_logo.png" alt="Rebellion Dogz Logo" class="logo" />
      <a href="index.html">Home</a>
      <a href="our_current_event.html">Our Current Event</a>
      <a href="signup.html">Open Mic Sign Up</a>
      <a href="contact.html">Contact</a>
  </nav>
  <h1 class="section-title">Open Mic Sign Up</h1>
</header>

<main class="event-info">

<section id="auth-section">
  <p class="note">
    Register once with your email.  
    Your email is used only for confirmation and is never shown publicly.
  </p>

  <label>
    Display Name
    <input id="displayName" />
  </label>

  <label>
    Email Address
    <input id="email" type="email" />
  </label>

  <button id="sendLink">Send Confirmation Link</button>
  <p id="authMessage"></p>
</section>

<section id="slots-section">
  <h2 class="section-title">Available Time Slots</h2>
  <p class="note">You may select one time slot only.</p>
  <div id="slots"></div>
</section>

</main>

<script>
const SUPABASE_URL = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
const SUPABASE_ANON_KEY = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const slotsDiv = document.getElementById("slots");
const authSection = document.getElementById("auth-section");
const authMessage = document.getElementById("authMessage");

let currentUser = null;

function formatWallTime(ts) {
  const d = new Date(ts);
  let hour = d.getUTCHours();
  const minute = d.getUTCMinutes();
  const ampm = hour >= 12 ? "PM" : "AM";
  hour = hour % 12 || 12;
  return `${hour}:${minute.toString().padStart(2, "0")} ${ampm}`;
}

document.getElementById("sendLink").onclick = async () => {
  const emailValue = document.getElementById("email").value.trim();
  const displayNameValue = document.getElementById("displayName").value.trim();

  if (!emailValue || !displayNameValue) {
    authMessage.textContent = "Both fields required.";
    return;
  }

  localStorage.setItem("display_name", displayNameValue);

  const { error } = await supabaseClient.auth.signInWithOtp({
    email: emailValue,
    options: {
      emailRedirectTo: "https://ickyras.github.io/RebDogz/signup.html"
    }
  });

  authMessage.textContent = error
    ? error.message
    : "Check your email to confirm.";
};

async function loadSlots() {
  slotsDiv.innerHTML = "";

  const { data: events } = await supabaseClient
    .from("events")
    .select("*")
    .eq("signup_open", true)
    .limit(1);

  if (!events || !events.length) {
    slotsDiv.textContent = "No open events.";
    return;
  }

  const { data: slots } = await supabaseClient
    .from("time_slots")
    .select(`
      *,
      profiles:booked_by (
        display_name
      )
    `)
    .eq("event_id", events[0].id)
    .order("starts_at");

  for (const slot of slots) {

    const row = document.createElement("div");
    row.className = "slot-row";

    const start = formatWallTime(slot.starts_at);
    const end = formatWallTime(slot.ends_at);

    const timeBtn = document.createElement("button");
    timeBtn.className = "slot-time";
    timeBtn.textContent = `${start} – ${end}`;

    const typeCol = document.createElement("div");
    typeCol.className = "slot-col";

    const introCol = document.createElement("div");
    introCol.className = "slot-col";

    if (slot.booked_by) {

      const name = slot.profiles?.display_name || "Booked";

      if (currentUser && slot.booked_by === currentUser.id) {

        timeBtn.classList.add("mine");
        timeBtn.textContent = `${start} – ${end} (${name} – click to cancel)`;

        typeCol.textContent = slot.type_of_act || "";
        introCol.textContent = slot.introduction_text || "";

        timeBtn.onclick = async () => {
          const confirmed = confirm("Cancel your booking?");
          if (!confirmed) return;

          await supabaseClient
            .from("time_slots")
            .update({
              booked_by: null,
              type_of_act: null,
              introduction_text: null
            })
            .eq("id", slot.id);

          loadSlots();
        };

      } else {

        timeBtn.disabled = true;
        timeBtn.classList.add("booked");

        typeCol.textContent = slot.type_of_act || "";
        introCol.textContent = "";
      }

    } else {

      if (!currentUser) {

        timeBtn.disabled = true;
        timeBtn.classList.add("disabled");

      } else {

        const typeInput = document.createElement("input");
        typeInput.placeholder = "Type of Act?";

        const introInput = document.createElement("input");
        introInput.placeholder = "How would you like to be introduced?";

        typeCol.appendChild(typeInput);
        introCol.appendChild(introInput);

        timeBtn.onclick = async () => {

          if (!typeInput.value.trim()) {
            alert("Please enter your Type of Act.");
            return;
          }

          await supabaseClient
            .from("time_slots")
            .update({
              booked_by: currentUser.id,
              type_of_act: typeInput.value.trim(),
              introduction_text: introInput.value.trim()
            })
            .eq("id", slot.id);

          loadSlots();
        };
      }
    }

    row.appendChild(timeBtn);
    row.appendChild(typeCol);
    row.appendChild(introCol);

    slotsDiv.appendChild(row);
  }
}

async function init() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  currentUser = user || null;

  if (currentUser) {
    const storedName = localStorage.getItem("display_name");

    if (storedName) {
      await supabaseClient
        .from("profiles")
        .update({ display_name: storedName })
        .eq("id", currentUser.id);

      localStorage.removeItem("display_name");
    }

    authSection.style.display = "none";
  }

  loadSlots();
}

init();
</script>

</body>
</html>