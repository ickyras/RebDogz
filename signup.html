<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign Up – Rebellion Dogz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: 0 auto;
    }

    nav {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid #ccc;
    }

    nav a {
      margin-right: 1rem;
      text-decoration: none;
      font-weight: bold;
      color: black;
    }

    main {
      padding: 2rem 1rem;
    }

    input, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
    }

    .slot {
      display: block;
      margin-top: 0.5rem;
      text-align: left;
    }

    .booked {
      background: #ddd;
      cursor: not-allowed;
    }

    .note {
      font-size: 0.9rem;
      opacity: 0.8;
    }
  </style>
</head>

<body>

<nav>
  <div><a href="/RebDogz/">Rebellion Dogz</a></div>
  <div>
    <a href="/RebDogz/signup.html">Sign Up</a>
  </div>
</nav>

<main>

<h1>Monthly Speaker Sign‑Up</h1>

<section id="auth-section">
  <p class="note">
    Register once with your email.  
    Your email is used only for confirmation and is never shown publicly.
  </p>

  <label>
    Display name
    <input id="displayName" />
  </label>

  <label>
    Email address
    <input id="email" type="email" />
  </label>

  <button id="sendLink">Send Confirmation Link</button>
  <p id="authMessage"></p>
</section>

<section id="slots-section" style="display:none;">
  <h2>Available Time Slots</h2>
  <p class="note">You may select one time slot only.</p>
  <div id="slots"></div>
</section>

</main>

<script>
  const SUPABASE_URL = "https://pkfrmugpppbqetekagyh.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_kIDCRuBpvOWGgy54L685HQ_zuFa-PLM";

  const supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  const authSection = document.getElementById("auth-section");
  const slotsSection = document.getElementById("slots-section");
  const slotsDiv = document.getElementById("slots");
  const authMessage = document.getElementById("authMessage");

  /*************************
   * TIME FORMAT (NO TZ MATH)
   *************************/
  function formatLocalTime(ts) {
    const timePart = ts.split(" ")[1].slice(0, 5); // HH:MM
    let [hour, minute] = timePart.split(":").map(Number);

    const ampm = hour >= 12 ? "PM" : "AM";
    hour = hour % 12 || 12;

    return `${hour}:${minute.toString().padStart(2, "0")} ${ampm}`;
  }

  document.getElementById("sendLink").onclick = async () => {
    const email = email.value.trim();
    const displayName = displayName.value.trim();

    if (!email || !displayName) {
      authMessage.textContent = "Both fields required.";
      return;
    }

    localStorage.setItem("display_name", displayName);

    const { error } = await supabaseClient.auth.signInWithOtp({
      email,
      options: {
        emailRedirectTo: "https://ickyras.github.io/RebDogz/signup.html"
      }
    });

    authMessage.textContent = error
      ? error.message
      : "Check your email to confirm.";
  };

  async function loadSlots(user) {
    slotsDiv.innerHTML = "";

    const { data: events } = await supabaseClient
      .from("events")
      .select("*")
      .eq("signup_open", true)
      .limit(1);

    if (!events?.length) {
      slotsDiv.textContent = "No open events.";
      return;
    }

    const { data: slots } = await supabaseClient
      .from("time_slots")
      .select("*")
      .eq("event_id", events[0].id)
      .order("starts_at");

    for (const slot of slots) {
      const btn = document.createElement("button");
      btn.className = "slot";

      const start = formatLocalTime(slot.starts_at);
      const end = formatLocalTime(slot.ends_at);

      if (slot.booked_by) {
        btn.textContent = `${start} – ${end} (Booked)`;
        btn.disabled = true;
        btn.classList.add("booked");
      } else {
        btn.textContent = `${start} – ${end}`;
        btn.onclick = async () => {
          await supabaseClient
            .from("time_slots")
            .update({ booked_by: user.id })
            .eq("id", slot.id);
          loadSlots(user);
        };
      }

      slotsDiv.appendChild(btn);
    }
  }

  async function init() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;

    authSection.style.display = "none";
    slotsSection.style.display = "block";

    await loadSlots(user);
  }

  init();
</script>

</body>
</html>