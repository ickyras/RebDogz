<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign Up – Rebellion Dogz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      padding: 1rem;
    }

    h1, h2 {
      margin-bottom: 0.5rem;
    }

    input, button {
      padding: 0.5rem;
      margin-top: 0.5rem;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      cursor: pointer;
    }

    .slot {
      display: block;
      margin-top: 0.5rem;
      text-align: left;
    }

    .booked {
      background: #ddd;
      cursor: not-allowed;
    }

    .note {
      font-size: 0.9rem;
      opacity: 0.8;
    }
  </style>
</head>

<body>

  <h1>Monthly Speaker Sign‑Up</h1>

  <!-- AUTH / REGISTRATION -->
  <section id="auth-section">
    <p class="note">
      Register once with your email.  
      Your email is used only for confirmation and is never shown publicly.
    </p>

    <label>
      Display name (shown publicly)
      <input id="displayName" placeholder="First name or username" />
    </label>

    <label>
      Email address
      <input id="email" type="email" placeholder="you@example.com" />
    </label>

    <button id="sendLink">Send Confirmation Link</button>

    <p id="authMessage"></p>
  </section>

  <!-- SLOTS -->
  <section id="slots-section" style="display:none;">
    <h2>Available Time Slots</h2>
    <p class="note">
      You may select one time slot only.
      Once booked, it cannot be changed online.
    </p>

    <div id="slots"></div>
  </section>

  <script>
    /*************************
     * SUPABASE CONFIG
     *************************/
    const SUPABASE_URL = "https://pkfrmugpppbqetekagyh.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_kIDCRuBpvOWGgy54L685HQ_zuFa-PLM";

    const supabase = supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    const authSection = document.getElementById("auth-section");
    const slotsSection = document.getElementById("slots-section");
    const slotsDiv = document.getElementById("slots");
    const authMessage = document.getElementById("authMessage");

    /*************************
     * SEND MAGIC LINK
     *************************/
    document.getElementById("sendLink").onclick = async () => {
      const email = document.getElementById("email").value.trim();
      const displayName = document.getElementById("displayName").value.trim();

      if (!email || !displayName) {
        authMessage.textContent = "Both fields are required.";
        return;
      }

      // Store display name locally until confirmation completes
      localStorage.setItem("display_name", displayName);

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: window.location.href
        }
      });

      if (error) {
        authMessage.textContent = error.message;
        return;
      }

      authMessage.textContent =
        "Check your email and click the confirmation link.";
    };

    /*************************
     * ENSURE PROFILE EXISTS
     *************************/
    async function ensureProfile(user) {
      const displayName =
        localStorage.getItem("display_name") || user.email;

      const { data } = await supabase
        .from("profiles")
        .select("id")
        .eq("id", user.id)
        .single();

      if (!data) {
        await supabase.from("profiles").insert({
          id: user.id,
          email: user.email,
          display_name: displayName
        });
      }
    }

    /*************************
     * LOAD SLOTS
     *************************/
    async function loadSlots(user) {
      slotsDiv.innerHTML = "";

      // Get the open event
      const { data: events } = await supabase
        .from("events")
        .select("*")
        .eq("signup_open", true)
        .limit(1);

      if (!events || events.length === 0) {
        slotsDiv.textContent = "No open events at this time.";
        return;
      }

      const eventId = events[0].id;

      const { data: slots } = await supabase
        .from("time_slots")
        .select("*")
        .eq("event_id", eventId)
        .order("starts_at");

      for (const slot of slots) {
        const btn = document.createElement("button");
        btn.className = "slot";

        const start = new Date(slot.starts_at).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit"
        });

        const end = new Date(slot.ends_at).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit"
        });

        if (slot.booked_by) {
          btn.textContent = `${start} – ${end} (Booked)`;
          btn.classList.add("booked");
          btn.disabled = true;
        } else {
          btn.textContent = `${start} – ${end}`;
          btn.onclick = async () => {
            const { error } = await supabase
              .from("time_slots")
              .update({ booked_by: user.id })
              .eq("id", slot.id);

            if (error) {
              alert(error.message);
            } else {
              loadSlots(user);
            }
          };
        }

        slotsDiv.appendChild(btn);
      }
    }

    /*************************
     * INIT
     *************************/
    async function init() {
      const {
        data: { user }
      } = await supabase.auth.getUser();

      if (!user) return;

      authSection.style.display = "none";
      slotsSection.style.display = "block";

      await ensureProfile(user);
      await loadSlots(user);
    }

    init();
  </script>

</body>
</html>