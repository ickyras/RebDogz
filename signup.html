<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Open Mic Sign Up – Rebellion Dogz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap" rel="stylesheet">

  <!-- Main Global Styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  main {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem 3rem;
  }

  /* ✅ Only style inputs globally — NOT buttons */
  input {
    width: 100%;
    padding: 0.6rem;
    margin-top: 0.3rem;
    border-radius: 6px;
    border: none;
  }

  button {
    cursor: pointer;
    font-weight: bold;
  }

  /* ✅ SLOT BUTTON — FULL CONTROL */
  .slot {
    display: block;
    width: 100%;
    margin-top: 0.4rem;
    padding: 12px 16px;
    font-size: 16px;
    line-height: 1.2;
    background: #e0e0e0;
    color: #000;
    border-radius: 10px;
    border: none;
    text-align: center;
    appearance: none;
    -webkit-appearance: none;
  }

  @media (max-width: 900px) {
    .slot {
      padding: 14px 16px;
      font-size: 16px;
      line-height: 1.25;
    }
  }

  .booked {
    background: #999;
    cursor: not-allowed;
    color: #000;
  }

  .mine {
    background: rgb(240, 27, 151);
    color: #fff;
  }

  .disabled {
    background: #666;
    color: #ccc;
    cursor: not-allowed;
  }

  .note {
    font-size: 0.9rem;
    opacity: 0.85;
  }

  /* ✅ NEW: Yellow email warning text */
  .email-warning {
    color: #ffef00;
    text-align: center;
    margin-top: 0.75rem;
    font-size: 0.95rem;
  }

  /* ✅ Mobile-only textarea spacing fix */
  @media (max-width: 900px) {

    textarea {
      margin-top: 0.25rem !important;
      min-height: 60px !important;
    }

    label {
      margin-bottom: 0.3rem;
      display: block;
    }

    textarea {
      margin-top: 0.2rem !important;
    }
  }
</style>
</head>

<body>

<header class="site-header">
  <nav class="top-nav">
      <img src="images/aa_logo.png" alt="Rebellion Dogz Logo" class="logo" />
      <a href="index.html">Home</a>
      <a href="our_current_event.html">Our Current Event</a>
      <a href="signup.html">Open Mic Sign Up</a>
      <a href="contact.html">Contact</a>
  </nav>
  <h1 class="section-title">Open Mic Sign Up</h1>
</header>

<main class="event-info">

<section id="auth-section">
<p class="signup-instructions">
  <strong>Instructions:</strong><br>
  Enter your first name and email. A confirmation email will be sent.  
  Click the link in that email — it will open in a new window and you'll have access to reserve a spot.  
  Your first name will be visible, but your email will not.<br><br>
  Fill in the text boxes if you like.  
  To cancel, follow the same process — once logged in you can cancel your slot.  
  One time slot per person, please.<br><br>
  If you receive an error, try again in an hour or email us.
</p>

<div class="auth-box">
  <input id="displayName" type="text" placeholder="First Name Only" />

  <input id="email" type="email" placeholder="Email Address" />
  <div class="email-note">(This will not show once you register)</div>

  <label class="marketing-check">
    <input type="checkbox" id="marketingOptIn" />
    <span>Email me about future events</span>
  </label>

  <button id="sendLink">Send Confirmation Link</button>

  <!-- ✅ NEW LINE ADDED -->
  <div class="email-warning">
    If the email is not in your inbox, <br>
    be sure and check your junk file.
  </div>

</div>

<p id="authMessage"></p>
</section>

<section id="slots-section">
  <h2 class="section-title">Available Time Slots</h2>
  <p class="note">You may select one time slot only. Fill in text boxes before reserving.</p>
  <div id="slots"></div>
</section>

</main>

<script>
const SUPABASE_URL = "https://pkfrmugpppbqetekagyh.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_kIDCRuBpvOWGgy54L685HQ_zuFa-PLM";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const slotsDiv = document.getElementById("slots");
const authSection = document.getElementById("auth-section");
const authMessage = document.getElementById("authMessage");

let currentUser = null;

function formatWallTime(ts) {
  const d = new Date(ts);
  let hour = d.getUTCHours();
  const minute = d.getUTCMinutes();
  const ampm = hour >= 12 ? "PM" : "AM";
  hour = hour % 12 || 12;
  return `${hour}:${minute.toString().padStart(2, "0")} ${ampm}`;
}

document.getElementById("sendLink").onclick = async () => {
  const emailValue = document.getElementById("email").value.trim();
  const displayNameValue = document.getElementById("displayName").value.trim();

  if (!emailValue || !displayNameValue) {
    authMessage.textContent = "Both fields required.";
    return;
  }

  localStorage.setItem("display_name", displayNameValue);

  const { error } = await supabaseClient.auth.signInWithOtp({
    email: emailValue,
    options: {
      emailRedirectTo: "https://ickyras.github.io/RebDogz/signup.html"
    }
  });

  authMessage.textContent = error
    ? error.message
    : "Check your email to confirm.";
};

async function loadSlots() {
  slotsDiv.innerHTML = "";

  const { data: events } = await supabaseClient
    .from("events")
    .select("*")
    .eq("signup_open", true)
    .limit(1);

  if (!events || !events.length) {
    slotsDiv.textContent = "No open events.";
    return;
  }

  const { data: slots } = await supabaseClient
    .from("time_slots")
    .select(`
      *,
      profiles:booked_by (
        display_name
      )
    `)
    .eq("event_id", events[0].id)
    .order("starts_at");

  for (const slot of slots) {

    const row = document.createElement("div");
    row.className = "slot-row";

    const start = formatWallTime(slot.starts_at);
    const end = formatWallTime(slot.ends_at);

    const timeBtn = document.createElement("button");
    timeBtn.className = "slot-time";
    timeBtn.textContent = `${start} – ${end}`;

    const typeCol = document.createElement("div");
    typeCol.className = "slot-col";

    const introCol = document.createElement("div");
    introCol.className = "slot-col";

    if (slot.booked_by) {

      const name = slot.profiles?.display_name || "Booked";

      if (currentUser && slot.booked_by === currentUser.id) {

        timeBtn.classList.add("mine");
        timeBtn.textContent = `${start} – ${end} (${name} – click to cancel)`;

        typeCol.textContent = slot.type_of_act || "";
        introCol.textContent = slot.introduction_text || "";

        timeBtn.onclick = async () => {
          const confirmed = confirm("Cancel your booking?");
          if (!confirmed) return;

          await supabaseClient
            .from("time_slots")
            .update({
              booked_by: null,
              type_of_act: null,
              introduction_text: null
            })
            .eq("id", slot.id);

          loadSlots();
        };

      } else {

        timeBtn.disabled = true;
        timeBtn.classList.add("booked");

        typeCol.textContent = slot.type_of_act || "";
        introCol.textContent = "";
      }

    } else {

      if (!currentUser) {

        timeBtn.disabled = true;
        timeBtn.classList.add("disabled");

      } else {

const typeInput = document.createElement("textarea");
typeInput.placeholder = "Type of Act?";
typeInput.rows = 2;

const introInput = document.createElement("textarea");
introInput.placeholder = "How would you like to be introduced?";
introInput.rows = 2;

        typeCol.appendChild(typeInput);
        introCol.appendChild(introInput);

timeBtn.onclick = async () => {

  await supabaseClient
    .from("time_slots")
    .update({
      booked_by: currentUser.id,
      type_of_act: typeInput.value.trim() || null,
      introduction_text: introInput.value.trim() || null
    })
    .eq("id", slot.id);

  loadSlots();
};
        
      }
    }

    row.appendChild(timeBtn);
    row.appendChild(typeCol);
    row.appendChild(introCol);

    slotsDiv.appendChild(row);
  }
}

async function init() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  currentUser = user || null;

  if (currentUser) {
    const storedName = localStorage.getItem("display_name");

    if (storedName) {
      await supabaseClient
        .from("profiles")
        .update({ display_name: storedName })
        .eq("id", currentUser.id);

      localStorage.removeItem("display_name");
    }

    authSection.style.display = "none";
  }

  loadSlots();
}

init();
</script>

</body>
</html>