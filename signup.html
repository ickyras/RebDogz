<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sign Up – Rebellion Dogz</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: sans-serif;
  max-width: 900px;
  margin: 0 auto;
}

main {
  padding: 2rem 1rem;
}

input, button {
  width: 100%;
  padding: 0.5rem;
  margin-top: 0.5rem;
}

button {
  cursor: pointer;
}

.slot {
  display: block;
  margin-top: 0.5rem;
  text-align: left;
}

.booked {
  background: #ddd;
  cursor: not-allowed;
}

.mine {
  background: #ffeeba;
}

.disabled {
  background: #eee;
  color: #666;
  cursor: not-allowed;
}

.note {
  font-size: 0.9rem;
  opacity: 0.8;
}
</style>
</head>

<body>

<main>

<h1>Monthly Speaker Sign‑Up</h1>

<section id="auth-section">
  <p class="note">
    Register once with your email.
    Your email is used only for confirmation and is never shown publicly.
  </p>

  <label>
    Display name
    <input id="displayName" />
  </label>

  <label>
    Email address
    <input id="email" type="email" />
  </label>

  <button id="sendLink">Send Confirmation Link</button>
  <p id="authMessage"></p>
</section>

<section id="slots-section">
  <h2>Available Time Slots</h2>
  <p class="note">You may select one time slot only.</p>
  <div id="slots"></div>
</section>

</main>

<script>
const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL_HERE";
const SUPABASE_ANON_KEY = "PASTE_YOUR_PUBLIC_ANON_KEY_HERE";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const slotsDiv = document.getElementById("slots");
const authSection = document.getElementById("auth-section");
const authMessage = document.getElementById("authMessage");

let currentUser = null;

/*************************
 * DISPLAY UTC WALL TIME
 *************************/
function formatWallTime(ts) {
  const d = new Date(ts);
  let hour = d.getUTCHours();
  const minute = d.getUTCMinutes().toString().padStart(2, "0");
  const ampm = hour >= 12 ? "PM" : "AM";
  hour = hour % 12 || 12;
  return `${hour}:${minute} ${ampm}`;
}

/*************************
 * MAGIC LINK LOGIN
 *************************/
document.getElementById("sendLink").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const displayName = document.getElementById("displayName").value.trim();

  if (!email || !displayName) {
    authMessage.textContent = "Both fields required.";
    return;
  }

  localStorage.setItem("display_name", displayName);

  const { error } = await supabaseClient.auth.signInWithOtp({
    email,
    options: {
      emailRedirectTo: window.location.href
    }
  });

  authMessage.textContent = error
    ? error.message
    : "Check your email to confirm.";
};

/*************************
 * LOAD SLOTS
 *************************/
async function loadSlots() {
  slotsDiv.innerHTML = "";

  const { data: events } = await supabaseClient
    .from("events")
    .select("*")
    .eq("signup_open", true)
    .limit(1);

  if (!events?.length) {
    slotsDiv.textContent = "No open events.";
    return;
  }

  const { data: slots } = await supabaseClient
    .from("time_slots")
    .select("*")
    .eq("event_id", events[0].id)
    .order("starts_at");

  for (const slot of slots) {
    const btn = document.createElement("button");
    btn.className = "slot";

    const start = formatWallTime(slot.starts_at);
    const end = formatWallTime(slot.ends_at);

    // ✅ SLOT BOOKED
    if (slot.booked_by) {

      // ✅ If it's YOUR booking → allow cancel
      if (currentUser && slot.booked_by === currentUser.id) {
        btn.textContent = `${start} – ${end} (Your booking – click to cancel)`;
        btn.classList.add("mine");

        btn.onclick = async () => {
          const confirmed = confirm("Cancel your booking?");
          if (!confirmed) return;

          await supabaseClient
            .from("time_slots")
            .update({ booked_by: null })
            .eq("id", slot.id);

          loadSlots();
        };

      } else {
        // ✅ Someone else's booking
        btn.textContent = `${start} – ${end} (Booked)`;
        btn.disabled = true;
        btn.classList.add("booked");
      }

    }

    // ✅ SLOT AVAILABLE
    else {

      if (!currentUser) {
        btn.textContent = `${start} – ${end}`;
        btn.disabled = true;
        btn.classList.add("disabled");
      } else {
        btn.textContent = `${start} – ${end}`;
        btn.onclick = async () => {
          await supabaseClient
            .from("time_slots")
            .update({ booked_by: currentUser.id })
            .eq("id", slot.id);

          loadSlots();
        };
      }
    }

    slotsDiv.appendChild(btn);
  }
}

/*************************
 * INIT
 *************************/
async function init() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  currentUser = user || null;

  if (currentUser) {
    authSection.style.display = "none";
  }

  loadSlots();
}

init();
</script>

</body>
</html>